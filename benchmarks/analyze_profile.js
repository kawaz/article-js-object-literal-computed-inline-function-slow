// Analyze .cpuprofile files generated by Bun's --cpu-prof option
// Usage: node analyze_profile.js <profile.cpuprofile>

const fs = require('fs');

const filename = process.argv[2] || 'bench_patterns.cpuprofile';
const data = JSON.parse(fs.readFileSync(filename, 'utf8'));

// Calculate total samples
const totalSamples = data.samples.length;
const totalTime = data.timeDeltas.reduce((a, b) => a + b, 0);

console.log(`Profile: ${filename}`);
console.log(`Total samples: ${totalSamples}`);
console.log(`Total time: ${(totalTime / 1000000).toFixed(2)} seconds`);
console.log('');

// Aggregate hitCount by function
const results = {};
data.nodes.forEach(n => {
  const name = n.callFrame.functionName;
  const line = n.callFrame.lineNumber;
  const file = n.callFrame.url ? n.callFrame.url.split('/').pop() : '';

  if (name && n.hitCount > 0) {
    const key = `${name}@${file}:${line}`;
    if (!results[key]) {
      results[key] = { name, file, line, hitCount: 0 };
    }
    results[key].hitCount += n.hitCount;
  }
});

// Sort by hitCount and display
console.log('Function | File | Line | hitCount | %');
console.log('---------|------|------|----------|---');

Object.values(results)
  .sort((a, b) => b.hitCount - a.hitCount)
  .slice(0, 15)
  .forEach(r => {
    const pct = ((r.hitCount / totalSamples) * 100).toFixed(1);
    console.log(
      `${r.name.padEnd(30)} | ${r.file.padEnd(20)} | ${String(r.line).padStart(4)} | ${String(r.hitCount).padStart(8)} | ${pct}%`
    );
  });
